<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API Test Page</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .test-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        border: 1px solid #ddd;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 4px;
        cursor: pointer;
        margin: 10px 5px;
        font-size: 16px;
      }
      button:hover {
        background: #0056b3;
      }
      .result {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin: 10px 0;
        white-space: pre-wrap;
        font-family: monospace;
      }
      .success {
        border-color: #28a745;
        background: #d4edda;
      }
      .error {
        border-color: #dc3545;
        background: #f8d7da;
      }
      .info {
        border-color: #17a2b8;
        background: #d1ecf1;
      }
    </style>
  </head>
  <body>
    <h1>🧪 API Test Page</h1>

    <div class="test-section">
      <h3>Test Your Next.js API Endpoint</h3>
      <p>
        Use this page to test if your API is working before testing with the
        Chrome extension.
      </p>

      <button onclick="testApiConnection()">Test API Connection</button>
      <button onclick="testFullPayload()">Test Full Payload</button>
      <button onclick="testCORS()">Test CORS</button>
      <button onclick="clearResults()">Clear Results</button>

      <div id="results"></div>
    </div>

    <div class="test-section">
      <h3>API Configuration</h3>
      <p>
        <strong>Endpoint:</strong>
        <code>http://localhost:3000/api/Buildtour</code>
      </p>
      <p><strong>Method:</strong> POST</p>
      <p><strong>Auth:</strong> Bearer apikey1234</p>
      <p><strong>Content-Type:</strong> application/json</p>
    </div>

    <script>
      const API_ENDPOINT = "http://localhost:3000/api/Buildtour";
      const API_KEY = "apikey1234";

      function addResult(message, type = "info") {
        const results = document.getElementById("results");
        const div = document.createElement("div");
        div.className = `result ${type}`;
        div.textContent = new Date().toLocaleTimeString() + " - " + message;
        results.appendChild(div);
        results.scrollTop = results.scrollHeight;
      }

      function clearResults() {
        document.getElementById("results").innerHTML = "";
      }

      async function testApiConnection() {
        addResult("🔍 Testing basic API connection...", "info");

        try {
          const response = await fetch(API_ENDPOINT, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${API_KEY}`,
            },
            body: JSON.stringify({
              test: "connection",
            }),
          });

          addResult(
            `✅ Connection successful! Status: ${response.status}`,
            "success"
          );

          const responseText = await response.text();
          addResult(`📄 Response: ${responseText}`, "info");
        } catch (error) {
          addResult(`❌ Connection failed: ${error.message}`, "error");

          if (error.message.includes("fetch")) {
            addResult(
              "💡 This usually means the Next.js server is not running. Try: npm run dev",
              "error"
            );
          }
        }
      }

      async function testFullPayload() {
        addResult("🚀 Testing with full tour data payload...", "info");

        const testPayload = {
          tourData: {
            selector: "#test-button",
            tagName: "button",
            textContent: "Test Button",
            attributes: {
              id: "test-button",
              class: "test-class",
            },
            position: {
              x: 100,
              y: 200,
              width: 120,
              height: 40,
            },
            viewportPosition: {
              x: 100,
              y: 200,
            },
            timestamp: new Date().toISOString(),
            stepNumber: 1,
            url: window.location.href,
          },
          metadata: {
            userAgent: navigator.userAgent,
            url: window.location.href,
            title: document.title,
          },
        };

        try {
          const response = await fetch(API_ENDPOINT, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${API_KEY}`,
            },
            body: JSON.stringify(testPayload),
          });

          addResult(
            `✅ Full payload test successful! Status: ${response.status}`,
            "success"
          );

          const responseData = await response.json();
          addResult(
            `📄 Response: ${JSON.stringify(responseData, null, 2)}`,
            "success"
          );
        } catch (error) {
          addResult(`❌ Full payload test failed: ${error.message}`, "error");
        }
      }

      async function testCORS() {
        addResult("🌐 Testing CORS preflight...", "info");

        try {
          const response = await fetch(API_ENDPOINT, {
            method: "OPTIONS",
          });

          addResult(
            `✅ CORS preflight successful! Status: ${response.status}`,
            "success"
          );

          const corsHeaders = {
            "Access-Control-Allow-Origin": response.headers.get(
              "Access-Control-Allow-Origin"
            ),
            "Access-Control-Allow-Methods": response.headers.get(
              "Access-Control-Allow-Methods"
            ),
            "Access-Control-Allow-Headers": response.headers.get(
              "Access-Control-Allow-Headers"
            ),
          };

          addResult(
            `📄 CORS Headers: ${JSON.stringify(corsHeaders, null, 2)}`,
            "info"
          );
        } catch (error) {
          addResult(`❌ CORS test failed: ${error.message}`, "error");
        }
      }

      // Auto-run connection test when page loads
      window.addEventListener("load", () => {
        addResult(
          "🚀 API Test Page loaded. Click buttons above to test your API.",
          "info"
        );
      });
    </script>
  </body>
</html>
